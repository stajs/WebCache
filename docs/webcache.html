<!DOCTYPE html>

<html>
<head>
	<title>WebCache.cs</title>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
	<link href="nocco.css" rel="stylesheet" media="all" type="text/css" />
	<script src="prettify.js" type="text/javascript"></script>
</head>
<body onload="prettyPrint()">
	<div id="container">
		<div id="background"></div>
			<div id="jump_to">
				Jump To &hellip;
				<div id="jump_wrapper">
					<div id="jump_page">
							<a class="source" href="asset.html">
								Asset.cs
							</a>
							<a class="source" href="bundle.html">
								Bundle.cs
							</a>
							<a class="source" href="datetimeextensions.html">
								DateTimeExtensions.cs
							</a>
							<a class="source" href="htmlhelperextensions.html">
								HtmlHelperExtensions.cs
							</a>
							<a class="source" href="webcache.html">
								WebCache.cs
							</a>
							<a class="source" href="webcachehttphandler.html">
								WebCacheHttpHandler.cs
							</a>
					</div>
				</div>
			</div>
		<table cellpadding="0" cellspacing="0">
			<thead>
				<tr>
					<th class="docs">
						<h1>WebCache.cs</h1>
					</th>
					<th class="code"></th>
				</tr>
			</thead>
			<tbody>
					<tr id="section_1">
						<td class="docs">
							<div class="pilwrap">
								<a class="pilcrow" href="#section_1">&#182;</a>
							</div>
							<p>Static class for configuring WebCache.</p>

<h2>Usage</h2>

<p>All calls to configure WebCache should be made during the start up of your application (i.e. <code>Application_Start()</code> in your <strong>Global.asax</strong>).</p>

<p>To <em>try</em> and delete the cache folder:</p>

<pre><code>WebCache.TryDeleteCacheFolder();
</code></pre>

<p>To register <code>Bundle</code>'s of <code>Asset</code>'s:</p>

<pre><code>WebCache.Register(
    new Bundle
    {
        Name = "Header",
        Assets = new List&lt;Asset&gt;
        {
            new Asset("/assets/styles/main.min.css"),
            new Asset("/assets/styles/app.min.css"),
            new Asset("/assets/scripts/header.js")
        }
    },
    new Bundle
    {
        Name = "Body",
        Assets = new List&lt;Asset&gt;
        {
            new Asset("/assets/scripts/log.js")
        }
    }
);
</code></pre>

						</td>
						<td class="code">
							<pre><code class='prettyprint'>
</code></pre>
						</td>
					</tr>
					<tr id="section_2">
						<td class="docs">
							<div class="pilwrap">
								<a class="pilcrow" href="#section_2">&#182;</a>
							</div>
							<p></p>

						</td>
						<td class="code">
							<pre><code class='prettyprint'>using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.Text;
using System.Web;
using System.Web.Hosting;
using Fluent.IO;

namespace WebCache
{
	public class WebCache
	{
		private static Dictionary&lt;string, List&lt;Asset&gt;&gt; _bundles = new Dictionary&lt;string, List&lt;Asset&gt;&gt;();

</code></pre>
						</td>
					</tr>
					<tr id="section_3">
						<td class="docs">
							<div class="pilwrap">
								<a class="pilcrow" href="#section_3">&#182;</a>
							</div>
							<p>It is possible to directly add items to a static dictionary, so expose a read-only copy.</p>

						</td>
						<td class="code">
							<pre><code class='prettyprint'>		public static ReadOnlyDictionary&lt;string, List&lt;Asset&gt;&gt; Bundles
		{
			get { return new ReadOnlyDictionary&lt;string, List&lt;Asset&gt;&gt;(_bundles); }
		}

</code></pre>
						</td>
					</tr>
					<tr id="section_4">
						<td class="docs">
							<div class="pilwrap">
								<a class="pilcrow" href="#section_4">&#182;</a>
							</div>
							<p>Helper method to register bundles since there isn't a public setter for the dictionary.</p>

						</td>
						<td class="code">
							<pre><code class='prettyprint'>		public static void Register(params Bundle[] bundles)
		{
			foreach (var bundle in bundles)
				_bundles.Add(bundle.Name, bundle.Assets);
		}

</code></pre>
						</td>
					</tr>
					<tr id="section_5">
						<td class="docs">
							<div class="pilwrap">
								<a class="pilcrow" href="#section_5">&#182;</a>
							</div>
							<p>Trying to recursively delete a folder can fail with an IOException (<code>The directory is not empty</code>) for
a number of reasons, including: locked files, permissions, read-only files. An easy way to reproduce
is to have a <a href="http://stackoverflow.com/questions/4102638/directoryinfo-deletetrue-doesnt-delete-when-folder-structure-is-open-in-windo">subdirectory open in Windows Explorer while deleting the parent</a>
I don't like any of the hack-arounds (although the <a href="http://stackoverflow.com/a/14933880">DeleteRecursivelyWithMagicDust()</a> is amusing).
I'm almost tempted to implement <a href="http://www.timstall.com/2009/02/killing-file-handles-but-not-process.html">a Kill 'em all</a>...          </p>

						</td>
						<td class="code">
							<pre><code class='prettyprint'>		public static void TryDeleteCacheFolder()
		{
			var applicationRoot = HostingEnvironment.ApplicationPhysicalPath;
			var cacheFolder = Path.Get(applicationRoot, Asset.CacheFolderName);

			if (!cacheFolder.Exists)
				return;

			try { cacheFolder.Delete(recursive: true); }
</code></pre>
						</td>
					</tr>
					<tr id="section_6">
						<td class="docs">
							<div class="pilwrap">
								<a class="pilcrow" href="#section_6">&#182;</a>
							</div>
							<p>Oh well, better luck next time...</p>

						</td>
						<td class="code">
							<pre><code class='prettyprint'>			catch {  }
		}
	}
}
</code></pre>
						</td>
					</tr>
			</tbody>
		</table>
	</div>
</body>
</html>
